<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeWorks LEGAL Payroll Register & Document Architect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #002a24; /* Dark Green/Teal */
            --secondary-color: #004d40; /* Medium Green/Teal */
            --accent-color: #D4AF37; /* Gold */
            --text-color: #333333;
            --bg-color: #f8f9fa;
            --light-gray: #e0e0e0;
            --white: #ffffff;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            font-size: 11pt;
            color: var(--text-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(to right, var(--secondary-color), #000000);
            color: var(--white);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            height: 140px;
            border-radius: 8px;
        }

        .app-title {
            font-size: 28px;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .app-subtitle {
            font-size: 16px;
            font-family: 'Lora', serif;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--bg-color);
            border-bottom: 1px solid #dce1e5;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Lora', serif;
        }

        .tab.active {
            background: var(--white);
            color: var(--accent-color);
        }

        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-color);
        }
        
        .page-content {
            padding: 30px;
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            color: var(--secondary-color);
            font-size: 22pt;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #eaeff5;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .control-group input,
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dce1e5;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary-color);
            color: var(--white);
            width: 100%;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 10pt;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: var(--bg-color);
            font-weight: 700;
            font-family: 'Lora', serif;
        }
        
        .table-container {
            overflow-x: auto;
        }

        .payslip, .certificate {
            border: 1px solid #dce1e5;
            border-radius: 12px;
            padding: 25px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .payslip-header, .certificate-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 4px solid var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .document-title-area h1 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            font-size: 28pt;
            margin: 0;
            text-align: right;
        }

        .footer {
            text-align: center;
            font-size: 9pt;
            color: #777;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        
        #payslip-view, #certificate-view {
            margin-top: 20px;
        }
        
        .payslip-section-title {
            font-family: 'Lora', serif;
            font-weight: 700;
            color: var(--secondary-color);
            background-color: var(--bg-color);
            padding: 8px;
            margin-top: 20px;
            border-radius: 4px;
        }
        
        .payslip-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .payslip-grid-item table {
            margin-top: 5px;
        }

        .payslip-grid-item table td {
            border: none;
            padding: 4px 0;
        }

        .payslip-grid-item table td:first-child {
            font-weight: 500;
            width: 40%;
        }

        #file-name {
            margin-top: 10px;
            font-style: italic;
            color: var(--secondary-color);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        /* Animation Styles */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.8s ease-out forwards; }
        
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.5; }
            50% { transform: translateY(-30px) rotate(180deg); opacity: 1; }
            100% { transform: translateY(0px) rotate(360deg); opacity: 0.5; }
        }
        .ember {
            position: absolute;
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            pointer-events: none;
        }
        .animation-delay-1 { animation-delay: 1s; }
        .animation-delay-2 { animation-delay: 2s; }
        .animation-delay-3 { animation-delay: 3s; }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
            }
            .container, .card, .payslip, .certificate {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }
            .no-print {
                display: none;
            }
            @page {
                size: letter;
                margin: 0.5in;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Floating Embers Background -->
        <div class="ember w-3 h-3 bg-teal-400/50 blur-sm left-[10%] top-[20%] animation-delay-1"></div>
        <div class="ember w-4 h-4 bg-amber-500/50 blur-sm left-[80%] top-[10%]"></div>
        <div class="ember w-2 h-2 bg-teal-300/50 blur-sm left-[90%] top-[60%] animation-delay-2"></div>
        <div class="ember w-3 h-3 bg-amber-400/50 blur left-[5%] top-[70%] animation-delay-3"></div>
        <div class="ember w-2 h-2 bg-teal-500/50 blur-sm left-[45%] top-[90%]"></div>

        <header class="no-print">
            <div>
                <div class="app-title">HomeWorks Document & Payroll Architect</div>
                <div class="app-subtitle">Payroll Register ‚Ä¢ Payslip Generator ‚Ä¢ Certificate Generator</div>
            </div>
            <img src="https://github.com/Z-Insights/HomeWorks/blob/main/HWPM%20Logo%203D.png?raw=true" alt="HomeWorks Logo" class="logo">
        </header>
        
        <div class="nav-tabs no-print">
            <div class="tab active" data-tab="payroll">Payroll Register</div>
            <div class="tab" data-tab="payslips">Payslip Generator</div>
            <div class="tab" data-tab="certificates">Certificate Generator</div>
            <div class="tab" data-tab="database">Employee Database</div>
        </div>
        
        <div id="app-body" class="animate-fadeIn">
            <!-- Content will be managed by JS -->
        </div>
        
        <!-- Footer -->
        <footer class="main-footer no-print" style="background: var(--primary-color); color: var(--white); padding: 40px 30px; text-align: center;">
             <button id="openModalBtn" class="btn" style="max-width: 250px; margin: 0 auto 30px auto; background-color: var(--accent-color); color: var(--primary-color);">Contact Us</button>
             <div class="footer-bottom" style="border-top: 1px solid var(--secondary-color); padding-top: 20px;">
                <p>A Project coded by <strong>Z-Insight</strong> ‚Äî All Rights Reserved</p>
                <p>Custom Project Apps: <a href="mailto:z-bridges@z-insightxy.com" style="color: var(--accent-color);">z-bridges@z-insightxy.com</a></p>
            </div>
        </footer>

    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal-overlay no-print" role="dialog" aria-modal="true">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn" aria-label="Close contact form">&times;</button>
            <h2 class="section-title">Contact Us</h2>
            <form id="contact-form">
                <div class="control-group">
                    <label for="contactName">Name</label>
                    <input type="text" id="contactName" placeholder="e.g. John Doe" required>
                </div>
                <div class="control-group">
                    <label for="contactWhatsapp">WhatsApp Number</label>
                    <input type="tel" id="contactWhatsapp" placeholder="+63 912 345 6789">
                </div>
                <div class="control-group">
                    <label for="contactEmail">Email</label>
                    <input type="email" id="contactEmail" placeholder="name@example.com" required>
                </div>
                <div class="control-group">
                    <label for="contactConcern">Concern</label>
                    <select id="contactConcern">
                        <option>Custom App Creation</option>
                        <option>General Inquiry</option>
                        <option>Report an Error</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="control-group" style="grid-column: 1 / -1;">
                    <label for="contactMessage">Message</label>
                    <textarea id="contactMessage" rows="4" placeholder="How can we help you?" required></textarea>
                </div>
                <div class="control-group" style="grid-column: 1 / -1;">
                    <button type="submit" class="btn" style="background-color: var(--accent-color); color: var(--primary-color);">
                        Send Message
                    </button>
                </div>
            </form>
            <div id="form-message" style="display: none; padding: 10px; margin-top: 15px; border-radius: 8px; text-align: center; font-weight: 600;">
                <!-- Message inserted via JavaScript -->
            </div>
        </div>
    </div>


    <script>
    // --- EMBEDDED KNOWLEDGE BASE & DATA ---
    const employeeDatabase = [
        { "id": "HWPM-0000", "fullName": "Zaphyr Zur Pomicpic", "designation": "Director of Operations", "company": "HWPM, BRCA, PILTD", "status": "Active", "rate": 12.00, "workEmail": "zaphyrzurpomicpic@gmail.com", "joinDate": "2018-11-26", "address": "Block 2 Lot 6 Rambutan St. Tierra Verde Village, Sasa, Davao, Davao Del Sur, 8000, Philippines", "sss": "34-1234567-8", "pagibig": "1234-5678-9012", "philhealth": "01-0123456789-0", "tin": "123-456-789-000", "bankName": "BDO", "accountNumber": "0012-3456-7890" },
        { "id": "HWPM-1004", "fullName": "Fatima May Namalata", "designation": "Business Development Manager", "company": "HWPM", "status": "Active", "rate": 6.00, "workEmail": "fatima@hwpmmd.com", "joinDate": "2020-02-17", "address": "48 MARS STREET MACASANDIG, CAGAYAN DE ORO, MISAMIS ORIENTAL, 9000, Philippines", "sss": "34-2345678-9", "pagibig": "2345-6789-0123", "philhealth": "02-0234567890-1", "tin": "234-567-890-000", "bankName": "BPI", "accountNumber": "1123-4567-8901" },
        { "id": "HWPM-1050", "fullName": "Shelly (Michelle) Jose", "designation": "Maintenance Manager", "company": "BRCA", "status": "Active", "rate": 4.75, "workEmail": "vendorsuccess@llmcpro.com", "joinDate": "2022-03-18", "address": "Block 1 Lot 49 Kensington 21, Lancaster New City, General Trias, Cavite, 4107, Philippines", "sss": "34-3456789-0", "pagibig": "3456-7890-1234", "philhealth": "03-0345678901-2", "tin": "345-678-901-000", "bankName": "Metrobank", "accountNumber": "2234-5678-9012" },
        { "id": "HWPM-1005", "fullName": "Mary Galillaga", "designation": "Customer Success Rep", "company": "HWPM", "status": "Active", "rate": 4.25, "workEmail": "mary@hwpmmd.com", "joinDate": "2022-05-06", "address": "7350 Maria Clara St. La Huerta, Paranaque City, Manila, 1700, Philippines", "sss": "34-4567890-1", "pagibig": "4567-8901-2345", "philhealth": "04-0456789012-3", "tin": "456-789-012-000", "bankName": "BPI", "accountNumber": "3345-6789-0123" },
        { "id": "HWPM-1070", "fullName": "Belle (Maybelline) Martinez", "designation": "Customer Success Rep", "company": "HWPM", "status": "Active", "rate": 5.00, "workEmail": "mabrosendo17@gmail.com", "joinDate": "2023-01-09", "address": "89 S Mateo Street, Taytay, Rizal, 1920, Philippines", "sss": "34-5678901-2", "pagibig": "5678-9012-3456", "philhealth": "05-0567890123-4", "tin": "567-890-123-000", "bankName": "BDO", "accountNumber": "4456-7890-1234" },
        { "id": "HWPM-2050", "fullName": "Christine Jeunesse Belmes", "designation": "Client Success Manager", "company": "HWPM", "status": "Active", "rate": 6.00, "workEmail": "christine.b@hwpmmd.com", "joinDate": "2024-04-22", "address": "Block 26 Lot 22B Liwayway Homes Subd. Anabu 1C, Imus, Cavite, 4103, Philippines", "sss": "34-6789012-3", "pagibig": "6789-0123-4567", "philhealth": "06-0678901234-5", "tin": "678-901-234-000", "bankName": "Security Bank", "accountNumber": "5567-8901-2345" },
        { "id": "HWPM-2021", "fullName": "Clyde Vandamme Martin", "designation": "General Success Coordinator", "company": "HWPM", "status": "Active", "rate": 3.75, "workEmail": "clydem@hwpmmd.com", "joinDate": "2024-10-07", "address": "Purok Mahalika, Brgy. Kimagango, Midsayap, North Cotabato, 9410, Philippines", "sss": "34-7890123-4", "pagibig": "7890-1234-5678", "philhealth": "07-0789012345-6", "tin": "789-012-345-000", "bankName": "BPI", "accountNumber": "6678-9012-3456" },
        { "id": "HWPM-2024", "fullName": "Janela Marie Brosas", "designation": "Customer Success Rep", "company": "HWPM", "status": "Active", "rate": 3.75, "workEmail": "janela@hwpmmd.com", "joinDate": "2024-10-07", "address": "Blk 47 Lot 14 Zontaville, Antipolo, Rizal, 1870, Philippines", "sss": "34-8901234-5", "pagibig": "8901-2345-6789", "philhealth": "08-0890123456-7", "tin": "890-123-456-000", "bankName": "BDO", "accountNumber": "7789-0123-4567" },
        { "id": "N/A-Sheryl", "fullName": "Sheryl Bautista", "designation": "Bookkeeping Coordinator", "company": "N/A", "status": "Active", "rate": 3.75, "workEmail": "N/A", "joinDate": "N/A", "address": "54 Gabronino Alley Bagong Barrio, Caloocan City, Metro Manila, 1400, Philippines", "sss": "34-9012345-6", "pagibig": "9012-3456-7890", "philhealth": "09-0901234567-8", "tin": "901-234-567-000", "bankName": "Metrobank", "accountNumber": "8890-1234-5678" },
        { "id": "BRCA-006", "fullName": "Jzel Ann Marie Aliviado", "designation": "Client Success Manager", "company": "BRCA", "status": "Active", "rate": 5.50, "workEmail": "jamaliviado@gmail.com", "joinDate": "2023-01-31", "address": "Blk 1 Lot 31 Deca Homes, Mandaue, Cebu, 6014", "sss": "34-0123456-7", "pagibig": "0123-4567-8901", "philhealth": "10-1012345678-9", "tin": "012-345-678-000", "bankName": "BPI", "accountNumber": "9901-2345-6789" },
        { "id": "BRCA-1014", "fullName": "Anson Gel Pangan", "designation": "Accounting Liaison Officer", "company": "BRCA, PILTD", "status": "Active", "rate": 5.25, "workEmail": "clientsupport03@baltimore...", "joinDate": "2023-11-20", "address": "1889 CBY Barracks II Tala, Caloocan City, Metro Manila, 1427, Philippines", "sss": "34-1123456-8", "pagibig": "1123-4567-8901", "philhealth": "11-1123456789-0", "tin": "112-345-678-000", "bankName": "BDO", "accountNumber": "1012-3456-7890" },
        { "id": "BRCA-1015", "fullName": "Adrian Arcilla", "designation": "Client Support Associate", "company": "BRCA", "status": "Active", "rate": 4.50, "workEmail": "adrianarcilla93@gmail.com", "joinDate": "2025-02-04", "address": "488 Anabu Road, Anabu 1-C, Imus, Cavite, 4103, Philippines", "sss": "34-2234567-9", "pagibig": "2234-5678-9012", "philhealth": "12-1234567890-1", "tin": "223-456-789-000", "bankName": "Metrobank", "accountNumber": "2123-4567-8901" }
    ];
    
    let processedPayrollData = [];
    let currentExchangeRate = 58.75;

    document.addEventListener('DOMContentLoaded', function() {
        // --- INITIALIZATION ---
        const appBody = document.getElementById('app-body');
        
        // --- PAGE/VIEW TEMPLATES ---
        const pageTemplates = {
            payroll: `
                <div class="card">
                    <h2 class="section-title">Weekly Payroll Register</h2>
                    <div class="controls-row no-print">
                        <div class="control-group">
                            <label for="payrollFile">Upload Weekly Timesheet (.csv, .xlsx)</label>
                            <input type="file" id="payrollFile" accept=".csv,.xlsx">
                            <div id="file-name"></div>
                        </div>
                         <div class="control-group">
                            <label for="exchangeRate">USD to PHP Exchange Rate</label>
                            <input type="number" id="exchangeRate" value="58.75" step="0.01">
                        </div>
                        <div class="control-group">
                            <label for="payPeriodStart">Pay Period Start</label>
                            <input type="date" id="payPeriodStart">
                        </div>
                        <div class="control-group">
                            <label for="payPeriodEnd">Pay Period End</label>
                            <input type="date" id="payPeriodEnd">
                        </div>
                        <div class="control-group">
                            <button class="btn" id="processPayrollBtn">Process Payroll</button>
                        </div>
                         <div class="control-group">
                            <button class="btn" id="downloadTemplateBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Download Template</button>
                        </div>
                         <div class="control-group">
                            <button class="btn" id="printReportBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Report</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="payroll-register-table">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Full Name</th><th>Rate ($)</th><th>Hours</th><th>PTO Hours</th><th>Gross Hourly Pay ($)</th><th>Gross PTO ($)</th><th>Commissions ($)</th><th>S-STARS Bonus ($)</th><th>Health Card ($)</th><th>SSS Reimb. ($)</th><th>Pag-IBIG Reimb. ($)</th><th>PhilHealth Reimb. ($)</th><th>Cash Adv/Loans ($)</th><th>Adjustments ($)</th><th>Total Gross Pay ($)</th><th>Take Home Pay ($)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>`,
            payslips: `
                <div class="card">
                    <h2 class="section-title">Payslip Generator</h2>
                     <div class="controls-row no-print">
                        <div class="control-group">
                            <label for="payslipEmployeeSelect">Select Employee</label>
                            <select id="payslipEmployeeSelect"><option value="">-- Select Employee --</option></select>
                        </div>
                        <div class="control-group">
                            <button class="btn" id="generatePayslipBtn">Generate Payslip</button>
                        </div>
                         <div class="control-group">
                            <button class="btn" id="printPayslipBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Payslip</button>
                        </div>
                    </div>
                    <div id="payslip-view"></div>
                </div>`,
            certificates: `
                <div class="card">
                     <h2 class="section-title">Certificate Generator</h2>
                     <div class="controls-row no-print">
                        <div class="control-group">
                            <label for="certEmployeeSelect">Select Employee</label>
                            <select id="certEmployeeSelect"><option value="">-- Select Employee --</option></select>
                        </div>
                        <div class="control-group">
                            <label for="certDate">Date Issued</label>
                            <input type="date" id="certDate">
                        </div>
                        <div class="control-group">
                            <button class="btn" id="generateCertBtn">Generate Certificate</button>
                        </div>
                         <div class="control-group">
                            <button class="btn" id="printCertBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Certificate</button>
                        </div>
                    </div>
                    <div id="certificate-view"></div>
                </div>`,
            database: `
                <div class="card">
                    <h2 class="section-title">Employee Database</h2>
                     <div class="table-container">
                        <table id="employee-database-table">
                            <thead>
                                <tr>
                                    <th>Employee ID</th><th>Full Name</th><th>Designation</th><th>Company</th><th>Status</th><th>Hourly Rate ($)</th><th>Work Email</th><th>Date of Joining</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>`
        };

        // --- RENDER & EVENT BINDING LOGIC ---
        function renderPage(pageId) {
            appBody.innerHTML = `<div class="page-content active animate-fadeIn">${pageTemplates[pageId]}</div>`;
            bindPageEventListeners(pageId);
        }

        function bindPageEventListeners(pageId) {
            if (pageId === 'payroll') {
                document.getElementById('processPayrollBtn').addEventListener('click', handlePayrollProcessing);
                document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
                document.getElementById('printReportBtn').addEventListener('click', () => printContent('payroll-tab'));
                document.getElementById('payrollFile').addEventListener('change', (event) => {
                    const fileNameDisplay = document.getElementById('file-name');
                    if (event.target.files.length > 0) {
                        fileNameDisplay.textContent = `Selected file: ${event.target.files[0].name}`;
                    } else {
                        fileNameDisplay.textContent = '';
                    }
                });
                setDefaultDates();
            }
            if (pageId === 'payslips') {
                document.getElementById('generatePayslipBtn').addEventListener('click', handlePayslipGeneration);
                document.getElementById('printPayslipBtn').addEventListener('click', () => printContent('payslip-to-print'));
                populateEmployeeSelects();
            }
            if (pageId === 'certificates') {
                document.getElementById('generateCertBtn').addEventListener('click', handleCertificateGeneration);
                document.getElementById('printCertBtn').addEventListener('click', () => printContent('certificate-to-print'));
                populateEmployeeSelects();
                document.getElementById('certDate').valueAsDate = new Date();
            }
            if (pageId === 'database') {
                renderEmployeeDatabase();
            }
        }
        
        // --- TAB SWITCHING LOGIC ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderPage(tab.dataset.tab);
            });
        });
        
        // --- PAYROLL PROCESSING & RENDERING ---
        function handlePayrollProcessing() {
            const file = document.getElementById('payrollFile').files[0];
            if (!file) { alert('Please upload a payroll file.'); return; }
            currentExchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 58.75;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    let sheetData;
                    if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    } else {
                        sheetData = Papa.parse(data, { header: false }).data;
                    }
                    parseAndCalculatePayroll(sheetData);
                } catch (error) {
                    console.error("Error processing file:", error);
                    alert("Error processing file. Please ensure it's a valid .csv or .xlsx file.");
                }
            };
            if (file.name.endsWith('.xlsx')) reader.readAsBinaryString(file);
            else reader.readAsText(file);
        }

        function parseAndCalculatePayroll(sheetData) {
            processedPayrollData = [];
            let headerRowIndex = sheetData.findIndex(row => row.map(cell => String(cell || '').toLowerCase()).includes('employee'));
            if (headerRowIndex === -1) {
                 alert("Could not find a valid header row. The header must contain a column named 'Employee'.");
                 return;
            }
            const headers = sheetData[headerRowIndex].map(h => String(h || '').trim().toLowerCase());
            const dataRows = sheetData.slice(headerRowIndex + 1);

            const headerMap = {
                'employee': headers.indexOf('employee'),
                'weekly hours rendered': headers.indexOf('weekly hours rendered'),
                'paid timeoff hours': headers.indexOf('paid timeoff hours'),
                'commissions': headers.indexOf('commissions'),
                's-stars bonus': headers.indexOf('s-stars bonus'),
                'health card credit': headers.indexOf('health card credit'),
                'sss': headers.indexOf('sss'),
                'pag ibig': headers.indexOf('pag ibig'),
                'philhealth': headers.indexOf('philhealth'),
                'cash adv/loans': headers.indexOf('cash adv/loans'),
                'compliance adjustment': headers.indexOf('compliance adjustment'),
            };
            
            dataRows.forEach(row => {
                const employeeName = row[headerMap['employee']];
                if (!employeeName) return;

                const employee = employeeDatabase.find(emp => emp.fullName.toLowerCase() === employeeName.toLowerCase());
                if (!employee) {
                    console.warn(`Employee not found in database: ${employeeName}`);
                    return;
                }

                const getNumericValue = (key) => parseFloat(row[headerMap[key]]) || 0;

                const weeklyHours = getNumericValue('weekly hours rendered');
                const ptoHours = getNumericValue('paid timeoff hours');
                const rate = employee.rate || 0;
                const grossHourlyPay = weeklyHours * rate;
                const grossPtoPay = ptoHours * rate;
                const commissions = getNumericValue('commissions');
                const bonus = getNumericValue('s-stars bonus');
                const healthCard = getNumericValue('health card credit');
                const sss = getNumericValue('sss');
                const pagibig = getNumericValue('pag ibig');
                const philhealth = getNumericValue('philhealth');
                const loans = getNumericValue('cash adv/loans');
                const adjustments = getNumericValue('compliance adjustment');

                const totalGrossPay = grossHourlyPay + grossPtoPay + commissions + bonus + healthCard + sss + pagibig + philhealth + adjustments;
                const takeHomePay = totalGrossPay - loans;
                
                processedPayrollData.push({
                    id: employee.id, fullName: employee.fullName, rate, weeklyHours, ptoHours, grossHourlyPay, grossPtoPay,
                    commissions, bonus, healthCard, sss, pagibig, philhealth, loans, adjustments, totalGrossPay, takeHomePay
                });
            });

            renderPayrollTable();
            alert('Payroll processed successfully!');
        }

        function renderPayrollTable() {
            const payrollTableBody = document.querySelector('#payroll-register-table tbody');
            const tfoot = document.querySelector('#payroll-register-table tfoot');
            if (!payrollTableBody || !tfoot) return;

            payrollTableBody.innerHTML = '';
            let totals = { weeklyHours:0, ptoHours:0, grossHourlyPay:0, grossPtoPay:0, commissions:0, bonus:0, healthCard:0, sss:0, pagibig:0, philhealth:0, loans:0, adjustments:0, totalGrossPay:0, takeHomePay:0 };

            processedPayrollData.forEach(data => {
                const row = payrollTableBody.insertRow();
                row.innerHTML = `
                    <td>${data.id}</td><td>${data.fullName}</td><td>${data.rate.toFixed(2)}</td>
                    <td>${data.weeklyHours.toFixed(2)}</td><td>${data.ptoHours.toFixed(2)}</td>
                    <td>${data.grossHourlyPay.toFixed(2)}</td><td>${data.grossPtoPay.toFixed(2)}</td>
                    <td>${data.commissions.toFixed(2)}</td><td>${data.bonus.toFixed(2)}</td>
                    <td>${data.healthCard.toFixed(2)}</td><td>${data.sss.toFixed(2)}</td>
                    <td>${data.pagibig.toFixed(2)}</td><td>${data.philhealth.toFixed(2)}</td>
                    <td>${data.loans.toFixed(2)}</td><td>${data.adjustments.toFixed(2)}</td>
                    <td><strong>${data.totalGrossPay.toFixed(2)}</strong></td><td><strong>${data.takeHomePay.toFixed(2)}</strong></td>
                `;
                for (const key in totals) { totals[key] += data[key] || 0; }
            });
            
            tfoot.innerHTML = `
                <tr style="font-weight: bold; background-color: var(--bg-color);">
                    <td colspan="3">TOTALS</td>
                    <td>${totals.weeklyHours.toFixed(2)}</td><td>${totals.ptoHours.toFixed(2)}</td>
                    <td>${totals.grossHourlyPay.toFixed(2)}</td><td>${totals.grossPtoPay.toFixed(2)}</td>
                    <td>${totals.commissions.toFixed(2)}</td><td>${totals.bonus.toFixed(2)}</td>
                    <td>${totals.healthCard.toFixed(2)}</td><td>${totals.sss.toFixed(2)}</td>
                    <td>${totals.pagibig.toFixed(2)}</td><td>${totals.philhealth.toFixed(2)}</td>
                    <td>${totals.loans.toFixed(2)}</td><td>${totals.adjustments.toFixed(2)}</td>
                    <td>${totals.totalGrossPay.toFixed(2)}</td><td>${totals.takeHomePay.toFixed(2)}</td>
                </tr>
            `;
        }

        function populateEmployeeSelects() {
            const payslipSelect = document.getElementById('payslipEmployeeSelect');
            const certSelect = document.getElementById('certEmployeeSelect');
            if(payslipSelect) {
                payslipSelect.innerHTML = '<option value="">-- Select Employee --</option>';
                processedPayrollData.forEach(emp => {
                    payslipSelect.innerHTML += `<option value="${emp.id}">${emp.fullName}</option>`;
                });
            }
             if(certSelect) {
                certSelect.innerHTML = '<option value="">-- Select Employee --</option>';
                processedPayrollData.forEach(emp => {
                    certSelect.innerHTML += `<option value="${emp.id}">${emp.fullName}</option>`;
                });
            }
        }
        
        // --- DOCUMENT GENERATION HANDLERS ---
        function handlePayslipGeneration() {
            const selectedId = document.getElementById('payslipEmployeeSelect').value;
            if (!selectedId) { alert('Please select an employee.'); return; }
            const payrollData = processedPayrollData.find(p => p.id === selectedId);
            const employeeData = employeeDatabase.find(e => e.id === selectedId);
            renderPayslip(payrollData, employeeData);
        }

        function handleCertificateGeneration() {
            const selectedId = document.getElementById('certEmployeeSelect').value;
            if (!selectedId) { alert('Please select an employee.'); return; }
            const payrollData = processedPayrollData.find(p => p.id === selectedId);
            const employeeData = employeeDatabase.find(e => e.id === selectedId);
            renderCertificate(payrollData, employeeData);
        }

        // --- RENDER FUNCTIONS FOR DOCUMENTS ---
        function renderPayslip(payrollData, employeeData) {
            const payslipView = document.getElementById('payslip-view');
            if (!payrollData || !employeeData) {
                payslipView.innerHTML = `<p style="color: var(--danger-color);">Could not generate payslip. Data not found.</p>`;
                return;
            }
            const toPHP = (amount) => (amount * currentExchangeRate).toLocaleString('en-US', { style: 'currency', currency: 'PHP' });
            
            const grossPayUSD = payrollData.grossHourlyPay + payrollData.grossPtoPay + payrollData.commissions + payrollData.bonus;
            const totalGovDeductionsUSD = payrollData.sss + payrollData.pagibig + payrollData.philhealth;
            const totalDeductionsUSD = totalGovDeductionsUSD + payrollData.adjustments + payrollData.loans;
            const netPayUSD = grossPayUSD - totalDeductionsUSD;
            const totalCreditedUSD = netPayUSD + totalGovDeductionsUSD; // Net Pay + Reimbursement

            const payPeriodStart = new Date(document.getElementById('payPeriodStart').value).toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            const payPeriodEnd = new Date(document.getElementById('payPeriodEnd').value).toLocaleDateString('en-US', { day: 'numeric', year: 'numeric' });
            const payDate = new Date(document.getElementById('payPeriodEnd').value);
            payDate.setDate(payDate.getDate() + 1);

            payslipView.innerHTML = `
                <div class="payslip" id="payslip-to-print">
                    <div class="payslip-header">
                        <div class="logo-area">
                            <img src="https://github.com/Z-Insights/HomeWorks/blob/main/HWPM%20Logo%203D.png?raw=true" alt="HomeWorks Logo" style="max-height: 70px;">
                        </div>
                        <div class="document-title-area">
                            <h1>Weekly Payslip</h1>
                            <p style="text-align:right; font-family: 'Lora', serif;">
                                <strong>Pay Period:</strong> ${payPeriodStart} - ${payPeriodEnd}<br>
                                <strong>Pay Date:</strong> ${payDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                            </p>
                        </div>
                    </div>
                    <div class="payslip-grid">
                        <div class="payslip-grid-item">
                            <h3 class="payslip-section-title">üë§ Employee Details</h3>
                            <table>
                                <tr><td>Full Name:</td><td>${employeeData.fullName}</td></tr>
                                <tr><td>Employee ID:</td><td>${employeeData.id}</td></tr>
                                <tr><td>Position:</td><td>${employeeData.designation}</td></tr>
                                <tr><td>Work Location:</td><td>${employeeData.address.split(',').slice(-3).join(', ').trim()}</td></tr>
                                <tr><td>Govt. IDs:</td><td>SSS: ${employeeData.sss} | PhilHealth: ${employeeData.philhealth} | Pag-IBIG: ${employeeData.pagibig} | TIN: ${employeeData.tin}</td></tr>
                            </table>
                        </div>
                        <div class="payslip-grid-item">
                            <h3 class="payslip-section-title">üåê Employer Details</h3>
                             <table>
                                <tr><td>Company:</td><td>HomeWorks Property Management LLC</td></tr>
                                <tr><td>Address:</td><td>100 West Road, Suite 300, Towson, MD 21204</td></tr>
                                <tr><td>Contact:</td><td>payroll@homeworks.com</td></tr>
                            </table>
                        </div>
                    </div>
                    <h3 class="payslip-section-title">üíµ Compensation Breakdown</h3>
                    <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr><td>Basic Pay (${payrollData.weeklyHours.toFixed(2)} hrs @ $${payrollData.rate.toFixed(2)}/hr)</td><td style="text-align:right;">${toPHP(payrollData.grossHourlyPay)}</td></tr>
                            <tr><td>Overtime/PTO Pay (${payrollData.ptoHours.toFixed(2)} hrs)</td><td style="text-align:right;">${toPHP(payrollData.grossPtoPay)}</td></tr>
                            <tr><td>Performance Bonus / Commissions</td><td style="text-align:right;">${toPHP(payrollData.commissions + payrollData.bonus)}</td></tr>
                            <tr style="font-weight:bold; background-color: var(--bg-color);"><td>Gross Pay</td><td style="text-align:right;">${toPHP(grossPayUSD)}</td></tr>
                       </tbody>
                    </table>
                    <h3 class="payslip-section-title">üìâ Deductions (Employee-Paid, Reimbursable by Company)</h3>
                    <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr><td>SSS Contribution</td><td style="text-align:right;">(${toPHP(payrollData.sss)})</td></tr>
                            <tr><td>PhilHealth Contribution</td><td style="text-align:right;">(${toPHP(payrollData.philhealth)})</td></tr>
                            <tr><td>Pag-IBIG Contribution</td><td style="text-align:right;">(${toPHP(payrollData.pagibig)})</td></tr>
                            <tr><td>Withholding Tax (from Adjustments)</td><td style="text-align:right;">(${toPHP(payrollData.adjustments)})</td></tr>
                            <tr><td>Cash Advance / Loans</td><td style="text-align:right;">(${toPHP(payrollData.loans)})</td></tr>
                            <tr style="font-weight:bold; background-color: var(--bg-color);"><td>Total Deductions</td><td style="text-align:right;">(${toPHP(totalDeductionsUSD)})</td></tr>
                       </tbody>
                    </table>
                    <h3 class="payslip-section-title">üí∞ Net Pay & Reimbursement</h3>
                     <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr style="font-weight:bold;"><td>Net Pay (Take-Home)</td><td style="text-align:right;">${toPHP(netPayUSD)}</td></tr>
                            <tr><td>Reimbursement of Gov‚Äôt Deductions</td><td style="text-align:right;">${toPHP(totalGovDeductionsUSD)}</td></tr>
                            <tr style="font-weight:bold; background-color: var(--secondary-color); color: var(--white); font-size: 1.2em;"><td>Total Credited to Bank</td><td style="text-align:right;">${toPHP(totalCreditedUSD)}</td></tr>
                       </tbody>
                    </table>
                    <div class="footer"><p>HomeWorks Property Management LLC | 100 West Road, Suite 300, Towson, MD 21204</p></div>
                </div>`;
        }
        
        function renderCertificate(payrollData, employeeData) {
            const certificateView = document.getElementById('certificate-view');
            if (!payrollData || !employeeData) {
                certificateView.innerHTML = `<p style="color: var(--danger-color);">Could not generate certificate.</p>`;
                return;
            }
            const issueDate = new Date(document.getElementById('certDate').value).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const joinDate = new Date(employeeData.joinDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            certificateView.innerHTML = `
                 <div class="certificate" id="certificate-to-print">
                    <div class="certificate-header">
                        <div class="logo-area">
                            <img src="https://github.com/Z-Insights/HomeWorks/blob/main/HWPM%20Logo%203D.png?raw=true" alt="HomeWorks Logo" style="max-height: 70px;">
                        </div>
                        <div class="document-title-area">
                            <h1>Certificate of Employment & Compensation</h1>
                        </div>
                    </div>
                    <div style="padding: 20px; line-height: 1.8; font-size: 12pt;">
                        <p style="text-align: right;"><strong>Date:</strong> ${issueDate}</p>
                        <h2 style="text-align: center; font-family: 'Playfair Display', serif; color: var(--primary-color); font-size: 18pt; margin: 30px 0;">TO WHOM IT MAY CONCERN:</h2>
                        <p>This is to certify that <strong>${employeeData.fullName}</strong> is an active, full-time employee of <strong>HomeWorks Property Management LLC</strong>.</p>
                        <p>He/She holds the position of <strong>${employeeData.designation}</strong>, and has been with the company since <strong>${joinDate}</strong>.</p>
                        <p>This certification is issued to attest that for the pay period ending on the date of this certificate, the employee has an average weekly compensation, inclusive of all bonuses, reimbursements, and allowances, amounting to approximately <strong>$${payrollData.takeHomePay.toFixed(2)} USD</strong>.</p>
                        <p>This document is issued upon the request of the aforementioned employee for whatever legal and lawful purpose it may serve.</p>
                        <div style="margin-top: 80px;"><p>Sincerely,</p><div style="margin-top: 60px; display: inline-block; border-top: 1px solid #000; padding-top: 5px;"><strong>Zaphyr Zur Pomicpic</strong><br>Director of Operations<br>HomeWorks Property Management LLC</div></div>
                    </div>
                     <div class="footer"><p>HomeWorks Property Management LLC | 100 West Road, Suite 300, Towson, MD 21204</p></div>
                </div>`;
        }

        function renderEmployeeDatabase() {
            const employeeDbTableBody = document.querySelector('#employee-database-table tbody');
            if (!employeeDbTableBody) return;
            employeeDbTableBody.innerHTML = '';
            employeeDatabase.forEach(emp => {
                const row = employeeDbTableBody.insertRow();
                row.innerHTML = `
                    <td>${emp.id}</td><td>${emp.fullName}</td><td>${emp.designation}</td>
                    <td>${emp.company}</td><td>${emp.status}</td>
                    <td>${emp.rate ? emp.rate.toFixed(2) : 'N/A'}</td>
                    <td>${emp.workEmail}</td><td>${emp.joinDate}</td>
                `;
            });
        }
        
        function downloadTemplate() {
            const headers = ["Employee", "Weekly Hours Rendered", "Paid TimeOff Hours", "Commissions", "S-STARS Bonus", "Health Card Credit", "SSS", "Pag Ibig", "PhilHealth", "Cash Adv/Loans", "Compliance Adjustment"];
            const sampleRow = ["Zaphyr Zur Pomicpic", "40", "0", "50", "0", "0", "10", "5", "5", "0", "0"];
            const csvData = [headers, sampleRow];
            let csvContent = csvData.map(e => e.join(",")).join("\r\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "payroll_template.csv";
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printContent(elementId) {
            const content = document.getElementById(elementId);
            if(content){
                html2canvas(content).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.autoPrint();
                    window.open(pdf.output('bloburl'), '_blank');
                });
            } else {
                alert('Please generate a document first.');
            }
        }
        
        // --- MODAL & FORM LOGIC ---
        const contactModal = document.getElementById('contactModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const contactForm = document.getElementById('contact-form');

        openModalBtn.addEventListener('click', () => contactModal.classList.add('active'));
        closeModalBtn.addEventListener('click', () => contactModal.classList.remove('active'));
        contactModal.addEventListener('click', (e) => {
            if (e.target === contactModal) contactModal.classList.remove('active');
        });

        contactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formMessage = document.getElementById('form-message');
            formMessage.textContent = 'Thank you for your message! We will get back to you shortly.';
            formMessage.style.backgroundColor = 'var(--secondary-color)';
            formMessage.style.color = 'var(--white)';
            formMessage.style.display = 'block';
            
            contactForm.reset();
            
            setTimeout(() => {
                formMessage.style.display = 'none';
                contactModal.classList.remove('active');
            }, 3000);
        });

        function setDefaultDates() {
            const today = new Date();
            const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            const lastDayOfWeek = new Date(firstDayOfWeek);
            lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 6);
            document.getElementById('payPeriodStart').valueAsDate = firstDayOfWeek;
            document.getElementById('payPeriodEnd').valueAsDate = lastDayOfWeek;
        }

        // Initial render
        renderPage('payroll');
    });
    </script>
</body>
</html>
